'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Calendar, Filter, RotateCcw } from 'lucide-react';
import { cn } from '@/lib/utils';

export interface FiltroData {
  tipo: 'hoje' | 'ontem' | 'semana' | 'mes' | 'trimestre' | 'ano' | 'personalizado';
  dataInicio: string;
  dataFim: string;
}

interface Props {
  onFiltroChange: (filtro: FiltroData) => void;
  filtroAtual: FiltroData;
}

export default function FiltrosDashboard({ onFiltroChange, filtroAtual }: Props) {
  const [showCustom, setShowCustom] = useState(false);
  const [dataInicio, setDataInicio] = useState('');
  const [dataFim, setDataFim] = useState('');

  // Calcular datas baseadas no tipo
  const calcularDatas = (tipo: FiltroData['tipo']): { inicio: string; fim: string } => {
    const hoje = new Date();
    const ontem = new Date(hoje);
    ontem.setDate(hoje.getDate() - 1);

    const inicioSemana = new Date(hoje);
    inicioSemana.setDate(hoje.getDate() - hoje.getDay());

    const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    
    const inicioTrimestre = new Date(hoje.getFullYear(), Math.floor(hoje.getMonth() / 3) * 3, 1);
    
    const inicioAno = new Date(hoje.getFullYear(), 0, 1);

    const formatarData = (data: Date) => data.toISOString().split('T')[0];

    switch (tipo) {
      case 'hoje':
        return {
          inicio: formatarData(hoje),
          fim: formatarData(hoje)
        };
      case 'ontem':
        return {
          inicio: formatarData(ontem),
          fim: formatarData(ontem)
        };
      case 'semana':
        return {
          inicio: formatarData(inicioSemana),
          fim: formatarData(hoje)
        };
      case 'mes':
        return {
          inicio: formatarData(inicioMes),
          fim: formatarData(hoje)
        };
      case 'trimestre':
        return {
          inicio: formatarData(inicioTrimestre),
          fim: formatarData(hoje)
        };
      case 'ano':
        return {
          inicio: formatarData(inicioAno),
          fim: formatarData(hoje)
        };
      default:
        return {
          inicio: dataInicio || formatarData(hoje),
          fim: dataFim || formatarData(hoje)
        };
    }
  };

  const handleTipoChange = (tipo: FiltroData['tipo']) => {
    setShowCustom(tipo === 'personalizado');
    
    if (tipo !== 'personalizado') {
      const datas = calcularDatas(tipo);
      onFiltroChange({
        tipo,
        dataInicio: datas.inicio,
        dataFim: datas.fim
      });
    }
  };

  const handleCustomDateChange = () => {
    if (dataInicio && dataFim) {
      onFiltroChange({
        tipo: 'personalizado',
        dataInicio,
        dataFim
      });
    }
  };

  // Resetar para hoje
  const resetarFiltro = () => {
    const datas = calcularDatas('hoje');
    onFiltroChange({
      tipo: 'hoje',
      dataInicio: datas.inicio,
      dataFim: datas.fim
    });
    setShowCustom(false);
    setDataInicio('');
    setDataFim('');
  };

  useEffect(() => {
    if (filtroAtual.tipo === 'personalizado') {
      setDataInicio(filtroAtual.dataInicio);
      setDataFim(filtroAtual.dataFim);
      setShowCustom(true);
    }
  }, [filtroAtual]);

  return (
    <div className="bg-slate-900/50 backdrop-blur-xl border border-slate-700/50 rounded-xl p-4">
      <div className="flex items-center gap-2 mb-4">
        <Filter className="h-4 w-4 text-cyan-400" />
        <h3 className="text-sm font-semibold text-white">Filtros de Período</h3>
      </div>

      <div className="flex flex-wrap items-center gap-3">
        {/* Botões de período pré-definido */}
        <div className="flex flex-wrap gap-2">
          {[
            { valor: 'hoje', label: 'Hoje' },
            { valor: 'ontem', label: 'Ontem' },
            { valor: 'semana', label: 'Esta Semana' },
            { valor: 'mes', label: 'Este Mês' },
            { valor: 'trimestre', label: 'Trimestre' },
            { valor: 'ano', label: 'Este Ano' },
          ].map((opcao) => (
            <Button
              key={opcao.valor}
              variant="ghost"
              size="sm"
              className={cn(
                "text-xs border transition-all duration-200",
                filtroAtual.tipo === opcao.valor
                  ? "bg-gradient-to-r from-cyan-500/20 to-blue-500/20 text-cyan-300 border-cyan-500/30"
                  : "border-slate-600 text-slate-300 hover:border-slate-500 hover:text-white"
              )}
              onClick={() => handleTipoChange(opcao.valor as FiltroData['tipo'])}
            >
              {opcao.label}
            </Button>
          ))}
        </div>

        {/* Botão período personalizado */}
        <Button
          variant="ghost"
          size="sm"
          className={cn(
            "text-xs border transition-all duration-200",
            filtroAtual.tipo === 'personalizado'
              ? "bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-300 border-purple-500/30"
              : "border-slate-600 text-slate-300 hover:border-slate-500 hover:text-white"
          )}
          onClick={() => handleTipoChange('personalizado')}
        >
          <Calendar className="h-3 w-3 mr-1" />
          Personalizado
        </Button>

        {/* Botão resetar */}
        <Button
          variant="ghost"
          size="sm"
          className="text-xs border border-red-500/30 text-red-400 hover:bg-red-500/10"
          onClick={resetarFiltro}
        >
          <RotateCcw className="h-3 w-3 mr-1" />
          Resetar
        </Button>
      </div>

      {/* Campos de data personalizada */}
      {showCustom && (
        <div className="mt-4 grid grid-cols-2 gap-3">
          <div className="space-y-1">
            <Label htmlFor="dataInicio" className="text-xs text-slate-300">
              Data Início
            </Label>
            <Input
              id="dataInicio"
              type="date"
              value={dataInicio}
              onChange={(e) => setDataInicio(e.target.value)}
              onBlur={handleCustomDateChange}
              className="bg-slate-800 border-slate-600 text-white text-xs"
            />
          </div>
          <div className="space-y-1">
            <Label htmlFor="dataFim" className="text-xs text-slate-300">
              Data Fim
            </Label>
            <Input
              id="dataFim"
              type="date"
              value={dataFim}
              onChange={(e) => setDataFim(e.target.value)}
              onBlur={handleCustomDateChange}
              className="bg-slate-800 border-slate-600 text-white text-xs"
            />
          </div>
        </div>
      )}

      {/* Informação do período atual */}
      <div className="mt-3 text-xs text-slate-400">
        Período: {new Date(filtroAtual.dataInicio).toLocaleDateString('pt-BR')} até {new Date(filtroAtual.dataFim).toLocaleDateString('pt-BR')}
      </div>
    </div>
  );
}